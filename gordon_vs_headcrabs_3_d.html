<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Gordon Freeman vs Headcrabs — 3D FPS</title>
<style>
  body { margin: 0; overflow: hidden; background: black; }
  #hud {
    position: fixed;
    bottom: 20px;
    left: 20px;
    color: #0f0;
    font-family: Arial, sans-serif;
    font-size: 18px;
    z-index: 1000;
  }
  #ammo { margin-top: 5px; }
  #hint {
    position: fixed;
    bottom: 20px;
    right: 20px;
    color: white;
    font-family: Arial, sans-serif;
    opacity: 0.9;
    z-index: 1000;
  }
  #overlay {
    position: fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-family:Arial, sans-serif;color:#fff;font-size:36px;z-index:2000;pointer-events:none;
  }
  #overlay.hidden{display:none}
</style>
</head>
<body>
<div id="hud">HP: <span id="hp">100</span><br><span id="ammo">Ammo: 30 / 90</span></div>
<div id="hint">Click to start • WASD - move • Mouse - look • LMB - shoot • R - reload</div>
<div id="overlay" class="hidden"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script>
setTimeout(()=>{
  if(!window.THREE){
    const ov=document.createElement('div');
    ov.style='position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.85);color:#fff;display:flex;align-items:center;justify-content:center;font-size:18px;z-index:9999;padding:20px;text-align:center;';
    ov.innerText='Error: Three.js not loaded. Try opening console (F12).';
    document.body.appendChild(ov);
    const s=document.createElement('script');
    s.src='https://unpkg.com/three@0.160.0/build/three.min.js';
    s.onload=()=>{ if(document.body.contains(ov)) document.body.removeChild(ov); console.log('Loaded fallback three.js'); };
    s.onerror=()=>{ console.error('Fallback three.js failed'); };
    document.head.appendChild(s);
  }
},500);

try{
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x550000);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.y = 1.6;

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const light = new THREE.DirectionalLight(0xffffff, 1);
light.position.set(10,20,10);
scene.add(light);
scene.add(new THREE.AmbientLight(0xffffff,0.5));

// --- Large room with decor ---
const room = new THREE.Mesh(
  new THREE.BoxGeometry(40, 10, 40),
  new THREE.MeshStandardMaterial({ color: 0x770000, side: THREE.BackSide })
);
scene.add(room);

// Floor
const floor = new THREE.Mesh(
  new THREE.PlaneGeometry(40,40),
  new THREE.MeshStandardMaterial({ color:0x550000 })
);
floor.rotation.x = -Math.PI/2;
scene.add(floor);

// Some decor (crates)
for(let i=0;i<25;i++){
  const crate = new THREE.Mesh(
    new THREE.BoxGeometry(2,2,2),
    new THREE.MeshStandardMaterial({color:0x333333})
  );
  crate.position.set((Math.random()-0.5)*30,1,(Math.random()-0.5)*30);
  crate.rotation.y = Math.random()*Math.PI*2;
  scene.add(crate);
}

// --- Controls ---
const keys={};
document.addEventListener('keydown',e=>keys[e.code]=true);
document.addEventListener('keyup',e=>keys[e.code]=false);
document.body.addEventListener('click',()=>document.body.requestPointerLock());
document.addEventListener('mousemove',e=>{
  if(document.pointerLockElement===document.body){
    camera.rotation.y-=e.movementX*0.0025;
    camera.rotation.x-=e.movementY*0.0025;
    camera.rotation.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,camera.rotation.x));
  }
});

// --- Simple audio (WebAudio) ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playTone(freq, duration, type='sine', vol=0.1){
  try{
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type; osc.frequency.value = freq;
    gain.gain.value = vol;
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + duration);
  }catch(e){console.warn('Audio error',e);} 
}

// --- Weapon (M4-like) ---
const weapon = new THREE.Mesh(new THREE.BoxGeometry(0.2,0.2,1.1), new THREE.MeshStandardMaterial({color:0x222222}));
weapon.position.set(0,-0.2,-0.6);
camera.add(weapon);
scene.add(camera);

let ammo=30, reserve=90;
let hp = 100;
let gameOver = false;
let lastDamage = 0; // ms

function updateHUD(){
  document.getElementById('hp').innerText = hp;
  document.getElementById('ammo').innerText = `Ammo: ${ammo} / ${reserve}`;
}
updateHUD();

function reload(){
  if(ammo>=30 || reserve<=0 || gameOver) return;
  // simple reload delay
  playTone(200,0.15,'sawtooth',0.08);
  const needed = 30 - ammo;
  const taken = Math.min(needed, reserve);
  setTimeout(()=>{
    ammo += taken; reserve -= taken; updateHUD();
  }, 800); // 800ms reload
}
document.addEventListener('keydown', e => { if(e.code==='KeyR') reload(); });

// --- Bullets ---
const bullets=[];
function shoot(){
  if(gameOver) return;
  if(ammo<=0){ playTone(120,0.05,'square',0.05); return; }
  ammo--; updateHUD();
  playTone(800,0.08,'square',0.12);
  const bullet=new THREE.Mesh(new THREE.SphereGeometry(0.05,8,8), new THREE.MeshBasicMaterial({color:0xffff00}));
  bullet.position.copy(camera.position);
  bullet.direction=new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
  scene.add(bullet);
  bullets.push(bullet);
}
document.addEventListener('mousedown', e=>{if(e.button===0 && document.pointerLockElement===document.body) shoot();});

// --- Enemies ---
const enemies=[];
function spawnEnemy(){ if(gameOver) return; 
  const crab = new THREE.Mesh(new THREE.SphereGeometry(0.45,16,16), new THREE.MeshStandardMaterial({color:0x111111}));
  crab.position.set((Math.random()-0.5)*30,0.45,(Math.random()-0.5)*30);
  scene.add(crab);
  enemies.push(crab);
}
const spawnInterval = setInterval(spawnEnemy,1200);

// --- Game loop ---
function doDamage(amount){
  const now = performance.now();
  if(now - lastDamage < 500) return; // 500ms invuln
  lastDamage = now;
  hp = Math.max(0, hp - amount);
  playTone(160,0.12,'sawtooth',0.14);
  updateHUD();
  // flash overlay
  const ov = document.getElementById('overlay');
  ov.innerText = '';
  ov.style.background = 'rgba(150,0,0,0.25)';
  ov.classList.remove('hidden');
  setTimeout(()=>{ if(!gameOver) ov.classList.add('hidden'); ov.style.background=''; }, 200);
  if(hp<=0){
    gameOver = true;
    clearInterval(spawnInterval);
    const overlay = document.getElementById('overlay');
    overlay.innerText = 'GAME OVER';
    overlay.style.background = 'rgba(0,0,0,0.6)';
    overlay.style.pointerEvents = 'auto';
    overlay.classList.remove('hidden');
  }
}

function animate(){
  if(gameOver){ renderer.render(scene,camera); requestAnimationFrame(animate); return; }
  requestAnimationFrame(animate);
  const speed=0.14;
  const dir=new THREE.Vector3();
  camera.getWorldDirection(dir);
  dir.y=0;dir.normalize();
  const right=new THREE.Vector3().crossVectors(dir,new THREE.Vector3(0,1,0));
  if(keys['KeyW'])camera.position.add(dir.clone().multiplyScalar(speed));
  if(keys['KeyS'])camera.position.add(dir.clone().multiplyScalar(-speed));
  if(keys['KeyA'])camera.position.add(right.clone().multiplyScalar(-speed));
  if(keys['KeyD'])camera.position.add(right.clone().multiplyScalar(speed));

  bullets.forEach((b,bi)=>{
    b.position.add(b.direction.clone().multiplyScalar(0.8));
    if(b.position.distanceTo(camera.position)>120){ scene.remove(b); bullets.splice(bi,1); }
  });

  enemies.forEach((e,ei)=>{
    const toPlayer = camera.position.clone().sub(e.position);
    const dist = toPlayer.length();
    toPlayer.normalize();
    // follow player
    e.position.add(toPlayer.multiplyScalar(0.03));

    // enemy attack if close
    if(dist < 1.2){
      // deal 10 HP and remove enemy
      doDamage(10);
      scene.remove(e);
      enemies.splice(ei,1);
      return;
    }

    // bullet collisions
    bullets.forEach((b,bi)=>{
      if(b.position.distanceTo(e.position) < 0.5){
        playTone(300,0.06,'sine',0.08);
        scene.remove(e); scene.remove(b);
        enemies.splice(ei,1); bullets.splice(bi,1);
      }
    });
  });

  renderer.render(scene,camera);
}
animate();

window.addEventListener('resize',()=>{camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight);});
}catch(e){
  console.error(e);
  const ov=document.createElement('div');
  ov.style='position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.9);color:#fff;display:flex;align-items:center;justify-content:center;font-size:16px;z-index:9999;padding:20px;text-align:center;';
  ov.innerText='Script error: '+(e && e.message ? e.message : e)+' — open console (F12)';
  document.body.appendChild(ov);
}
</script>
</body>
</html>